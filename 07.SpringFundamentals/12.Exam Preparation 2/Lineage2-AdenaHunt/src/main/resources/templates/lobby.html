<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Lobby</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Red+Hat+Display:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/css/lobby.css">
</head>
<body>

<header>
    <div class="player-adena">
        <img src="/images/adena-icon.png" alt="Adena">
        <span th:text="${player.adena}">4,720</span>
    </div>
    <a href="/logout" class="logout-button">Logout</a>
</header>

<main class="main-content">

    <!-- Player Card -->
    <section class="panel player-card">

        <div class="player-name-level-wrapper">
            <div class="player-nickname" th:text="${'Hello, ' + player.nickname}">Hello, Mandarin!</div>
            <div class="player-level" th:text="${player.level + ' Lv'}">17 Lv</div>
        </div>

        <!-- Player Info -->
        <div class="player-info">
            <div class="card-header">
                <div class="image-wrapper">
                    <img class="class-image" th:src="${player.bannerImg}" />
                    <div class="class-name" th:text="${player.playerClass.displayName}">Storm Screamer</div>
                </div>
            </div>
            <ul class="class-stats">
                <li><span>Health</span><div class="stat" th:text="${#numbers.formatDecimal(player.health, 1, 2)}">17895</div></li>
                <li><span>Attack</span><div class="stat" th:text="${#numbers.formatDecimal(player.attack, 1, 2)}">653</div></li>
                <li><span>Defense</span><div class="stat" th:text="${#numbers.formatDecimal(player.defence, 1, 2)}">785</div></li>
            </ul>
            <div class="class-abilities" th:each="booster : ${boosters}">
                <div class="abilities-label">Booster Abilities</div>
                <div class="class-ability">
                    <img th:src="${booster.icon}" alt="XP Icon">
                    <span th:text="${booster.name}">+5% XP Gain</span>
                </div>
            </div>
            <div class="description">
                Elite ranged class known for precision and mobility.
            </div>
        </div>
    </section>

    <!-- Party + Farm Zone -->
    <!-- Party Panel with Members + Farm Zone -->
    <div class="party-zone-panel panel">
        <div class="party-box">
            <h3 class="section-title">Your Party</h3>
            <div class="party-content">
                <!-- WHEN THE PLAYER HAS PARTY -->
                <div class="party-members" th:if="${player.party != null}">
                    <div class="party-member-card leader">
                        <img class="party-banner" th:src="${player.party.leader.bannerImg}" />
                        <div class="party-info">
                            <div class="party-nickname" th:text="${player.party.leader.nickname}">Mandarin</div>
                            <div class="party-level" th:text="${'Lv ' + player.party.leader.level}">Lv 17</div>
                            <div class="party-adena" th:text="${'Adena: ' + player.party.leader.adena}">Adena: 12,540</div>
                        </div>
                        <div class="party-role-tag leader">Party Leader</div>
                    </div>
                    <div class="party-member-card" th:each="member : ${partyMembers}" th:if="${member.id != player.party.leader.id}">
                        <img class="party-banner" th:src="${member.bannerImg}" />
                        <div class="party-info">
                            <div class="party-nickname" th:text="${member.nickname}">Kratos</div>
                            <div class="party-level" th:text="${'Lv ' + member.level}">Lv 15</div>
                            <div class="party-adena" th:text="${'Adena: ' + member.adena}">Adena: 8,220</div>
                        </div>
                        <div class="party-role-tag">Party Member</div>
                    </div>
                </div>

                <!-- WHEN THE PLAYER HAS NO PARTY -->
                <div class="party-empty" th:if="${player.party == null}">
                    <div class="party-empty-text">
                        <ol class="party-rules">
                            <li>A party can have up to <strong>3 players</strong>: 1 Party Leader and 2 Party Members.</li>
                            <li>A party is automatically formed when you invite another player.</li>
                            <li>The player who invites others becomes the <strong>Party Leader</strong>.</li>
                            <li>Any member can dismiss the party, which disbands it for everyone.</li>
                            <li>Players not in a party can receive or send invites at any time.</li>
                        </ol>
                    </div>
                </div>

                <div class="party-actions">
                    <button class="btn invite" onclick="openInviteModal()">Invite Player</button>
                    <form th:if="${player.party != null}" class="party-action-form" th:action="@{'/party/' + ${player.party.id}}" th:method="DELETE">
                        <button class="btn dismiss">Dismiss Party</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="farm-box">
            <a href="/mobs" class="btn enter-farm"><span>Enter Farm Zone</span></a>
        </div>
    </div>

    <!-- Mob Spawn Log -->
    <section class="panel">
        <div class="mob-log-container">

            <!-- Repeat for more mobs -->
            <div class="mob-entry" th:each="mob : ${lastMobs}">
                <img class="mob-image" th:src="${mob.imageUrl}" />
                <div class="mob-info">
                    <div class="mob-header">
                        <span class="mob-name" th:text="${mob.name}">Buffalo</span>
                        <span class="mob-level" th:text="${'Lv' + mob.level}">Lv9</span>
                        <span class="mob-type-tag blue" th:text="${mob.mobType.displayName}">Blue Champion</span>
                    </div>
                    <div class="mob-meta">
                        <span class="spawn-time" th:text="${#temporals.format(mob.createdOn, 'HH:mm:ss')}">10:03:27</span>
                        <span class="mob-area-tag" th:text="${mob.spawnArea}">Cruma Tower</span>
                    </div>
                    <div class="mob-stats">
                        <span>Health: <strong th:text="${#numbers.formatDecimal(mob.health,1 ,2)}">2,500</strong></span>
                        <span>Attack: <strong th:text="${#numbers.formatDecimal(mob.attack,1 ,2)}">510</strong></span>
                        <span>Defense: <strong th:text="${#numbers.formatDecimal(mob.defence,1 ,2)}">310</strong></span>
                    </div>
                    <div class="mob-drop">
                        <div class="drop-item">
                            <img src="/images/adena-icon.png" alt="Adena" />
                            <span th:text="${mob.adenaDrop}">132</span>
                        </div>
                        <div class="drop-item">
                            <img src="/images/xp-booster-icon.png" alt="XP" />
                            <span th:text="${mob.xpDrop + ' XP'}">340 XP</span>
                        </div>
                    </div>
                    <div class="mob-description">
                        A wild, charging farm creature.
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>

<!-- Invite Player Modal -->
<div class="modal-overlay" id="invite-modal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeInviteModal()" aria-label="Close">
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>

        <h3 class="modal-title">System Players</h3>

        <div class="invite-player-list">
            <div class="invite-player-entry" th:each="currentPlayer : ${playersForParty}">
                <img class="invite-player-banner" th:src="${currentPlayer.bannerImg}"/>
                <div class="invite-player-info">
                    <div class="invite-player-nickname" th:text="${currentPlayer.nickname}">Leona</div>
                    <div class="invite-player-meta" th:text="${'Lv ' + currentPlayer.level}">Lv 27 </div>
                    <div class="invite-player-meta" th:text="${'Adena: ' + currentPlayer.adena}">Adena: 9,109</div>
                    <div class="invite-player-class">
                        <span class="invite-player-class-label">Class:</span>
                        <span th:text="${currentPlayer.playerClass.displayName}">Moonlight Sentinel</span>
                    </div>
                </div>
                <form class="invite-player-form" th:action="@{'/party?receiverId=' + ${currentPlayer.id}}" method="post">
                    <button type="submit" class="btn invite-btn">Invite</button>
                </form>
            </div>
        </div>
    </div>
</div>

<footer th:replace="~{fragments/commons::footer}"></footer>
<script>
    function openInviteModal() {
        document.getElementById('invite-modal').classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeInviteModal() {
        document.getElementById('invite-modal').classList.remove('active');
        document.body.style.overflow = '';
    }

    document.addEventListener('DOMContentLoaded', () => {
    const modal = document.getElementById('invite-modal');
    const closeBtn = document.querySelector('.invite-modal-close');

    window.addEventListener('click', (event) => {
        if (event.target === modal) {
            closeInviteModal();
        }
    });
});
</script>
</body>
</html>